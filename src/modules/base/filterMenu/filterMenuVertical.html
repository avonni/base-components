<template>
    <div class="slds-m-bottom_x-small" if:true={showSelectedItems}>
        <c-pill-container
            actions={pillActions}
            items={selectedItems}
            data-element-id="avonni-pill-container"
            onactionclick={handleSelectedItemRemove}
            onblur={handleBlur}
            onfocus={handleFocus}
        ></c-pill-container>
    </div>
    <button
        if:true={collapsible}
        data-element-id="lightning-icon-toggle"
        class="
            slds-button
            slds-section__title-action
            avonni-filter-menu__title-button_base
            slds-p-left_none
        "
        onblur={handleBlur}
        onclick={handleToggleSection}
        onfocus={handleFocus}
    >
        <lightning-icon
            icon-name={computedCollapsibleButtonIconName}
            size="x-small"
            class="slds-button__icon slds-button__icon_left"
        ></lightning-icon>
        <lightning-icon
            if:true={computedShowDownIcon}
            icon-name={iconName}
            size={iconSize}
            class="slds-m-right_x-small"
        ></lightning-icon>
        <div
            class="
                avonni-filter-menu__form-element-legend
                slds-form-element__legend
            "
            title={title}
        >
            <div
                class="
                    avonni-filter-menu__label-container-collapsible
                    avonni-filter-menu__allow-shrink-width
                    slds-truncate
                "
                title={label}
            >
                <span class="avonni-filter-menu__label slds-truncate"
                    >{label}</span
                >
            </div>

            <span
                if:true={showCount}
                class="avonni-filter-menu__label slds-m-left_xx-small"
            >
                ({selectedItemCountLabel})
            </span>

            <lightning-helptext
                if:true={fieldLevelHelp}
                content={fieldLevelHelp}
                class="slds-m-left_xx-small"
                style="top: -0.25rem"
                data-element-id="lightning-helptext"
            ></lightning-helptext>
        </div>
    </button>
    <template if:false={collapsible}>
        <div
            class="
                slds-form-element__legend
                slds-float_none
                slds-truncate slds-is-relative
                avonni-filter-menu__form-element-legend
            "
            title={title}
        >
            <lightning-icon
                if:true={computedShowDownIcon}
                icon-name={iconName}
                size={iconSize}
                class="slds-m-right_x-small"
            ></lightning-icon>
            <div
                class="
                    avonni-filter-menu__label-container-non-collapsible
                    avonni-filter-menu__allow-shrink-width
                    slds-truncate
                "
                title={label}
            >
                <span class="avonni-filter-menu__label slds-truncate"
                    >{label}</span
                >
            </div>

            <span
                if:true={showCount}
                class="avonni-filter-menu__label slds-m-left_xx-small"
            >
                ({selectedItemCountLabel})
            </span>

            <lightning-helptext
                if:true={fieldLevelHelp}
                content={fieldLevelHelp}
                class="slds-m-left_xx-small"
                style="top: -0.25rem"
                data-element-id="lightning-helptext"
            ></lightning-helptext>
        </div>
    </template>
    <template if:true={displayFilters}>
        <!-- Search box -->
        <div class="avonni-filter-menu__search-wrapper">
            <lightning-input
                if:true={computedTypeAttributes.allowSearch}
                class="
                    slds-grow
                    avonni-filter-menu__allow-shrink-width
                    slds-p-vertical_x-small
                "
                disabled={disabled}
                label={computedTypeAttributes.searchInputPlaceholder}
                placeholder={computedTypeAttributes.searchInputPlaceholder}
                variant="label-hidden"
                type="search"
                value={searchTerm}
                autocomplete="off"
                data-element-id="lightning-input"
                onblur={handleBlur}
                onchange={handleSearch}
                onfocus={handleFocus}
            ></lightning-input>

            <template if:true={showResetButtonTop}>
                <lightning-button
                    class="slds-m-left_x-small"
                    disabled={disabledOrLoading}
                    label={resetButtonLabel}
                    title={resetButtonLabel}
                    variant="base"
                    data-element-id="lightning-button-reset-top"
                    onblur={handleBlur}
                    onclick={handleResetClick}
                    onfocus={handleFocus}
                ></lightning-button>
            </template>
        </div>

        <p if:true={showNoResultMessage} class="slds-p-around_small">
            No matches found
        </p>

        <div
            class={computedVerticalListClass}
            data-element-id="div-vertical-list"
        >
            <!-- List -->
            <template if:true={isList}>
                <c-tree
                    if:true={hasNestedItems}
                    class="slds-p-vertical_xx-small"
                    disabled={disabled}
                    independent-multi-select
                    is-multi-select={computedTypeAttributes.isMultiSelect}
                    items={visibleItems}
                    selected-items={currentValue}
                    data-element-id="avonni-tree"
                    onactionclick={handleTreeActionClick}
                    onblur={handleBlur}
                    onloadmore={handleTreeLoadMore}
                    onfocus={handleFocus}
                    onselect={handleTreeSelect}
                ></c-tree>
                <c-input-choice-set
                    if:false={hasNestedItems}
                    class="slds-p-vertical_xx-small"
                    accesskey={accessKey}
                    disabled={disabled}
                    is-multi-select={computedTypeAttributes.isMultiSelect}
                    label={label}
                    variant="label-hidden"
                    options={visibleItems}
                    value={currentValue}
                    name={name}
                    data-element-id="avonni-input-choice-set"
                    onblur={handleBlur}
                    onchange={handleChoiceSetChange}
                    onfocus={handleFocus}
                ></c-input-choice-set>
                <lightning-button
                    if:true={showLoadMoreButton}
                    class="avonni-filter-menu__load-more-button"
                    label="Load more"
                    variant="base"
                    data-element-id="lightning-button-load-more"
                    onblur={handleBlur}
                    onclick={handleLoadMore}
                    onfocus={handleFocus}
                ></lightning-button>
            </template>

            <!-- Loading spinner -->
            <template if:true={isLoading}>
                <div
                    class="
                        slds-is-relative
                        slds-m-around_large
                        slds-show_inline-block
                    "
                >
                    <lightning-spinner
                        size="small"
                        alternative-text={loadingStateAlternativeText}
                        data-element-id="lightning-spinner"
                    ></lightning-spinner>
                </div>
            </template>

            <template if:false={isLoading}>
                <!-- Date Range -->
                <c-input-date-range
                    if:true={isDateRange}
                    class="slds-show slds-m-vertical_small"
                    date-style={computedTypeAttributes.dateStyle}
                    end-date={dateRangeEndDate}
                    label={label}
                    label-end-date={computedTypeAttributes.labelEndDate}
                    label-end-time={computedTypeAttributes.labelEndTime}
                    label-start-date={computedTypeAttributes.labelStartDate}
                    label-start-time={computedTypeAttributes.labelStartTime}
                    start-date={dateRangeStartDate}
                    time-style={computedTypeAttributes.timeStyle}
                    timezone={computedTypeAttributes.timezone}
                    type={computedTypeAttributes.type}
                    variant="label-hidden"
                    week-start-day={weekStartDay}
                    data-element-id="avonni-input-date-range"
                    onblur={handleBlur}
                    onchange={handleDateRangeChange}
                    onfocus={handleFocus}
                ></c-input-date-range>

                <!-- Range -->
                <c-slider
                    if:true={isRange}
                    class="slds-m-vertical_small"
                    disable-swap
                    hide-min-max-values={computedTypeAttributes.hideMinMaxValues}
                    label={label}
                    max={computedTypeAttributes.max}
                    min={computedTypeAttributes.min}
                    show-pin={computedTypeAttributes.showPin}
                    show-tick-marks={computedTypeAttributes.showTickMarks}
                    step={computedTypeAttributes.step}
                    tick-mark-style={computedTypeAttributes.tickMarkStyle}
                    unit={computedTypeAttributes.unit}
                    unit-attributes={computedTypeAttributes.unitAttributes}
                    value={rangeValue}
                    variant="label-hidden"
                    data-element-id="avonni-slider"
                    onblur={handleBlur}
                    onchange={handleRangeChange}
                    onfocus={handleFocus}
                ></c-slider>

                <!-- Time Range -->
                <div
                    if:true={isTimeRange}
                    class="slds-grid slds-wrap"
                    data-element-id="input-time-range-container"
                >
                    <div class="slds-form-element">
                        <label
                            if:true={computedTypeAttributes.labelStartTime}
                            class="slds-form-element__label"
                            for="start-time"
                            data-element-id="label-start-time"
                            >{computedTypeAttributes.labelStartTime}
                        </label>
                        <lightning-input
                            label="start-time"
                            name="start-time"
                            time-style={computedTypeAttributes.timeStyle}
                            type="time"
                            value={timeRangeStartTime}
                            variant="label-hidden"
                            data-is-focusable
                            data-element-id="lightning-input-start-time"
                            onblur={handleBlur}
                            onchange={handleTimeRangeChange}
                            onfocus={handleFocus}
                        ></lightning-input>
                    </div>

                    <div class="slds-form-element">
                        <label
                            if:true={computedTypeAttributes.labelEndTime}
                            class="slds-form-element__label"
                            for="end-time"
                            data-element-id="label-end-time"
                            >{computedTypeAttributes.labelEndTime}
                        </label>
                        <lightning-input
                            label="end-time"
                            name="end-time"
                            time-style={computedTypeAttributes.timeStyle}
                            type="time"
                            value={timeRangeEndTime}
                            variant="label-hidden"
                            data-is-focusable
                            data-element-id="lightning-input-end-time"
                            onblur={handleBlur}
                            onchange={handleTimeRangeChange}
                            onfocus={handleFocus}
                        ></lightning-input>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <!-- Reset and apply buttons -->
    <lightning-menu-divider
        if:false={hideBottomButtons}
    ></lightning-menu-divider>
    <div
        if:false={hideBottomButtons}
        class="
            slds-p-horizontal_small
            slds-p-bottom_x-small
            slds-text-align_right
        "
    >
        <lightning-button
            if:true={showResetButtonBottom}
            class="slds-m-right_x-small"
            disabled={disabledOrLoading}
            label={resetButtonLabel}
            title={resetButtonLabel}
            variant="base"
            data-element-id="lightning-button-reset-bottom"
            onblur={handleBlur}
            onclick={handleResetClick}
            onfocus={handleFocus}
        ></lightning-button>
        <lightning-button
            if:false={hideApplyButton}
            disabled={disabledOrLoading}
            label={applyButtonLabel}
            title={applyButtonLabel}
            variant="brand"
            data-element-id="lightning-button-apply"
            onblur={handleBlur}
            onclick={handleApply}
            onfocus={handleFocus}
        ></lightning-button>
    </div>
</template>
