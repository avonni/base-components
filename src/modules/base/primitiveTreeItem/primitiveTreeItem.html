<template>
    <div class="slds-is-relative">
        <div
            class="avonni-primitive-tree-item__item slds-is-relative slds-grid"
            data-element-id="div-item"
            onclick={handleClick}
        >
            <lightning-button-icon
                class={computedButtonClass}
                alternative-text={buttonLabel}
                aria-expanded={isExpanded}
                icon-name={computedIconName}
                size="small"
                tabindex="-1"
                title={buttonLabel}
                variant="bare"
                data-type="chevron"
                onmousedown={stopPropagation}
            >
            </lightning-button-icon>

            <div class="slds-has-flexi-truncate">
                <div
                    class="
                        slds-grid slds-grid_vertical-align-center
                        avonni-primitive-tree-item__options
                    "
                    onfocusin={showBranchButtons}
                    onfocusout={hideBranchButtons}
                    onmouseenter={showBranchButtons}
                    onmouseleave={hideBranchButtons}
                >
                    <div class={computedLabelClass}>
                        <a
                            if:true={showLink}
                            href={href}
                            data-element-id="a-label-link"
                            onmousedown={handleLinkMouseDown}
                        >
                            {label}
                        </a>
                        <span if:false={showLink}>{label}</span>
                    </div>

                    <div
                        if:true={actions.length}
                        class="
                            avonni-primitive-tree-item__branch-buttons
                            slds-grid slds-grid_vertical-align-center
                        "
                        data-element-id="div-branch-buttons"
                        onmousedown={stopPropagation}
                    >
                        <!-- Action icons -->
                        <template for:each={buttonActions} for:item="action">
                            <lightning-button-icon
                                key={action.name}
                                class="
                                    slds-m-left_x-small
                                    slds-m-vertical_xx-small
                                "
                                alternative-text={action.label}
                                disabled={isDisabled}
                                icon-name={action.iconName}
                                name={action.name}
                                variant="bare"
                                onclick={handleActionClick}
                            ></lightning-button-icon>
                        </template>

                        <!-- Action menu -->
                        <lightning-button-menu
                            class="slds-p-horizontal_x-small"
                            alternative-text="Show menu"
                            disabled={isDisabled}
                            menu-alignment="right"
                            variant="bare"
                            data-element-id="lightning-button-menu"
                            onblur={hideBranchButtons}
                            onclick={stopPropagation}
                            onclose={handleActionMenuClose}
                            onfocusout={stopPropagation}
                            onopen={handleActionMenuOpen}
                            onselect={handleActionClick}
                        >
                            <template for:each={menuActions} for:item="action">
                                <lightning-menu-item
                                    key={action.name}
                                    icon-name={action.iconName}
                                    label={action.label}
                                    value={action.name}
                                ></lightning-menu-item>
                            </template>
                        </lightning-button-menu>
                    </div>
                </div>

                <!-- Metatext -->
                <div
                    if:true={metatext}
                    class="
                        slds-truncate
                        slds-text-color_weak
                        avonni-primitive-tree-item__metatext
                    "
                    title={metatext}
                >
                    <a
                        if:true={showLink}
                        href={href}
                        onmousedown={handleLinkMouseDown}
                        >{metatext}</a
                    >
                    <span if:false={showLink}>{metatext}</span>
                </div>
            </div>
        </div>

        <!-- Popover -->
        <div
            if:true={popoverVisible}
            class="
                slds-is-absolute slds-popover
                avonni-primitive-tree-item__popover
            "
            aria-label="Edit item"
            role="dialog"
            onmousedown={stopPropagation}
        >
            <!-- Close button -->
            <div class="slds-text-align_right">
                <lightning-button-icon
                    alternative-text="Close dialog"
                    class="slds-popover__close"
                    icon-name="utility:close"
                    variant="bare"
                    size="small"
                    data-element-id="lightning-button-icon-close"
                    onclick={togglePopoverVisibility}
                    onkeydown={handlePopoverCloseKeyDown}
                ></lightning-button-icon>
            </div>

            <div
                class="slds-popover__body slds-scrollable_y"
                data-element-id="div-popover-body"
            >
                <!-- Label -->
                <lightning-input
                    type="text"
                    label="Label"
                    value={draftValues.label}
                    data-element-id="lightning-input-label"
                    onblur={handleLabelBlur}
                    onchange={handleLabelEdit}
                ></lightning-input>

                <!-- Name -->
                <lightning-input
                    type="text"
                    label="Name"
                    value={draftValues.nodename}
                    data-element-id="lightning-input-name"
                    onchange={handleNameEdit}
                ></lightning-input>

                <!-- Href -->
                <lightning-input
                    type="text"
                    label="Link"
                    value={draftValues.href}
                    data-element-id="lightning-input-href"
                    onchange={handleHrefEdit}
                ></lightning-input>

                <!-- Metatext -->
                <lightning-input
                    class="metatext-input slds-m-bottom_small"
                    type="text"
                    label="Metatext"
                    value={draftValues.metatext}
                    data-element-id="lightning-input-metatext"
                    onchange={handleMetatextEdit}
                ></lightning-input>

                <!-- Expanded toggle -->
                <lightning-input
                    class="expanded-toggle slds-m-bottom_xx-small"
                    type="toggle"
                    label="Expanded"
                    checked={draftValues.isExpanded}
                    data-element-id="lightning-input-expanded"
                    onchange={handleExpandedEdit}
                ></lightning-input>

                <!-- Disabled toggle -->
                <lightning-input
                    class="disabled-toggle"
                    type="toggle"
                    label="Disabled"
                    checked={draftValues.isDisabled}
                    data-element-id="lightning-input-disabled"
                    onchange={handleDisabledEdit}
                ></lightning-input>
            </div>

            <div
                class="
                    slds-popover__footer
                    slds-grid
                    slds-grid_align-spread
                    slds-grid_vertical-align-center
                "
            >
                <lightning-button
                    class="slds-m-right_xx-small"
                    label="Cancel"
                    onclick={togglePopoverVisibility}
                ></lightning-button>
                <lightning-button
                    disabled={hasError}
                    label="Done"
                    variant="brand"
                    data-element-id="lightning-button-done"
                    onclick={handleDone}
                    onkeydown={handlePopoverDoneKeyDown}
                ></lightning-button>
            </div>
        </div>

        <!-- Child items -->
        <div if:true={showExpanded} role="group">
            <template for:each={childItems} for:item="item">
                <c-primitive-tree-item
                    class="
                        avonni-primitive-tree-item__child-item
                        slds-is-relative
                    "
                    key={item.key}
                    actions={actions}
                    aria-disabled={item.isDisabled}
                    aria-expanded={item.strexpanded}
                    aria-label={item.label}
                    aria-level={item.level}
                    aria-selected={item.selected}
                    child-items={item.children}
                    focused-child={item.focusedChild}
                    href={item.href}
                    is-disabled={item.isDisabled}
                    is-expanded={item.isExpanded}
                    is-leaf={item.isLeaf}
                    is-loading={item.isLoading}
                    label={item.label}
                    level={item.level}
                    loading-state-alternative-text={loadingStateAlternativeText}
                    metatext={item.metatext}
                    node-key={item.key}
                    node-ref={item.nodeRef}
                    nodename={item.name}
                    role="treeitem"
                    sortable={sortable}
                    data-element-id="avonni-primitive-tree-item"
                    data-key={item.key}
                ></c-primitive-tree-item>
            </template>

            <div
                if:true={isLoading}
                class="
                    avonni-primitive-tree-item__loading-spinner
                    slds-is-relative
                "
            >
                <lightning-spinner
                    alternative-text={loadingStateAlternativeText}
                    size="small"
                ></lightning-spinner>
            </div>
        </div>
    </div>
</template>
