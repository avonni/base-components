<template>
    <div class="slds-template__container slds-grid slds-grid_vertical">
        <div class="slds-grid slds-grid_vertical">
            <p
                if:true={label}
                class="slds-m-bottom_x-small avonni-list__header_font"
                data-element-id="label"
            >
                {labelToDisplay}
            </p>
            <span
                lwc:dom="manual"
                class="slds-assistive-text"
                id="instructions"
                aria-live="assertive"
            ></span>
            <span
                if:true={alternativeText}
                class="slds-assistive-text"
                data-element-id="span-alternative-text"
            >
                {alternativeText}
            </span>
        </div>
        <div
            class={computedListContainerClass}
            data-element-id="list-container"
            onscroll={handleScroll}
        >
            <div
                if:true={isSingleLine}
                class="
                    avonni-list__flex-col
                    avonni-list__page-change-button-container
                "
            >
                <lightning-button-icon
                    class="avonni-list__page-change-button"
                    alternative-text={previousButtonAlternativeText}
                    disabled={previousPageDisabled}
                    icon-name="utility:chevronleft"
                    size="large"
                    variant="bare"
                    data-element-id="previous-page-button"
                    onclick={handlePreviousPage}
                ></lightning-button-icon>
            </div>
            <c-layout
                class={computedListClass}
                direction={layoutDirection}
                multiple-rows={isNotSingleLine}
                role="list"
                vertical-align="stretch"
                data-element-id="list-element"
                onprivatecardrendered={handleCardRendered}
                onsizechange={handleLayoutSizeChange}
            >
                <template
                    for:each={displayedItems}
                    for:item="item"
                    for:index="index"
                >
                    <c-layout-item
                        key={item.name}
                        class={computedItemWrapperClass}
                        aria-describedby="instructions"
                        aria-label={item.label}
                        large-container-size={largeContainerColSize}
                        medium-container-size={mediumContainerColSize}
                        role="listitem"
                        small-container-size={smallContainerColSize}
                        size={colSize}
                        tabindex="0"
                        data-element-id="li-item"
                        data-element-temp-index={item.index}
                        data-index={item.index}
                        data-name={item.name}
                        data-selected={item.selected}
                        onclick={handleItemClick}
                        onkeydown={handleKeyDown}
                        onmousedown={dragStart}
                        onmousemove={drag}
                        onmouseup={handleItemMouseUp}
                        ontouchend={handleItemMouseUp}
                        ontouchmove={drag}
                        ontouchstart={dragStart}
                    >
                        <div
                            class={computedItemClass}
                            data-element-id="div-item"
                        >
                            <c-card
                                media-position={item.imagePosition}
                                data-element-id="avonni-card"
                            >
                                <!-- Media Actions  -->
                                <div
                                    if:true={hasMediaActions}
                                    class="
                                        avonni-list__item-media-action-top-right
                                    "
                                    slot="media-actions"
                                >
                                    <div
                                        if:true={item.hasImage}
                                        onkeydown={handleStopKeyDown}
                                    >
                                        <c-primitive-actions
                                            actions={computedMediaActions}
                                            button-icon-size="small"
                                            button-icon-variant="border-filled"
                                            visible-actions={computedVisibleMediaActions}
                                            data-element-id="primitive-media-actions"
                                            data-item-index={item.index}
                                            onactionclick={handleMediaActionClick}
                                            onclick={stopPropagation}
                                            onmousedown={stopPropagation}
                                            ontouchstart={stopPropagation}
                                        ></c-primitive-actions>
                                    </div>
                                </div>
                                <div
                                    class="avonni-list__image_container"
                                    slot="media"
                                >
                                    <div
                                        class="
                                            slds-grid
                                            slds-grid_vertical-align-center
                                            avonni-list__image_container
                                        "
                                    >
                                        <lightning-icon
                                            if:true={showSortIconInLeftImage}
                                            class="
                                                slds-p-horizontal_xx-small
                                                avonni-list__item-sortable-icon-cursor
                                            "
                                            icon-name={sortableIconName}
                                            size="x-small"
                                            data-element-id="lightning-icon-sort-left"
                                            onclick={stopPropagation}
                                        ></lightning-icon>
                                        <div
                                            if:true={item.imageSrc}
                                            style={computedImageStyle}
                                            class="slds-is-relative"
                                            data-element-id="list-img"
                                        >
                                            <img
                                                loading="lazy"
                                                style={computedImageStyle}
                                                class={computedImageMediaClass}
                                                alt={item.imageAlternativeText}
                                                draggable="false"
                                                src={item.imageSrc}
                                                data-element-id="list-img-media"
                                                data-item-index={item.index}
                                                onerror={handleItemImageError}
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="
                                        slds-grid
                                        slds-grid_vertical-align-center
                                    "
                                >
                                    <lightning-icon
                                        if:true={showSortIconLeftOfContent}
                                        class="
                                            slds-p-horizontal_xx-small
                                            avonni-list__item-sortable-icon-cursor
                                        "
                                        icon-name={sortableIconName}
                                        size="x-small"
                                        data-element-id="lightning-icon-sort-left"
                                    ></lightning-icon>
                                    <div
                                        class="
                                            slds-grid
                                            avonni-list__flex-col
                                            avonni-list-item-body__vertical-alignment
                                            slds-has-flexi-truncate
                                            avonni-list-item-body
                                        "
                                    >
                                        <div
                                            if:true={isCheckList}
                                            class="
                                                avonni-list__item-checkbox-button
                                                slds-m-right_x-small
                                            "
                                        >
                                            <input
                                                checked={item.checked}
                                                disabled={item.uncheckable}
                                                id={item.name}
                                                type="checkbox"
                                                data-element-id="item-input-checkbox"
                                                data-index={item.index}
                                                onclick={handleItemCheck}
                                                onkeydown={handleCheckboxKeyDown}
                                                onmousedown={stopPropagation}
                                            />
                                            <label for={item.name}>
                                                <span
                                                    class="slds-assistive-text"
                                                ></span>
                                            </label>
                                        </div>
                                        <c-primitive-avatar
                                            if:true={item.isAvatarLeft}
                                            class={item.computedAvatarClass}
                                            fallback-icon-name={item.avatar.fallbackIconName}
                                            initials={item.avatar.initials}
                                            presence={item.avatar.presence}
                                            presence-position={item.avatar.presencePosition}
                                            size={item.avatar.size}
                                            src={item.avatar.src}
                                            variant={item.avatar.variant}
                                            data-element-id="avonni-avatar"
                                            onmousedown={handleAvatarDragStart}
                                        ></c-primitive-avatar>
                                        <div
                                            class={item.computedTextColor}
                                            data-element-id="avonni-list-item-body-text-color"
                                        >
                                            <!-- Item label and icons -->
                                            <div
                                                class={computedItemHeaderClass}
                                            >
                                                <c-primitive-avatar
                                                    if:true={item.isAvatarLeftOfTitle}
                                                    class={item.computedAvatarClass}
                                                    fallback-icon-name={item.avatar.fallbackIconName}
                                                    initials={item.avatar.initials}
                                                    presence={item.avatar.presence}
                                                    presence-position={item.avatar.presencePosition}
                                                    size={item.avatar.size}
                                                    src={item.avatar.src}
                                                    variant={item.avatar.variant}
                                                    data-element-id="avonni-avatar"
                                                    onmousedown={handleAvatarDragStart}
                                                ></c-primitive-avatar>
                                                <div
                                                    class="
                                                        slds-truncate
                                                        avonni-list__item-header_font
                                                    "
                                                    title={item.label}
                                                    data-element-id="div-item-label"
                                                >
                                                    <a
                                                        if:true={item.href}
                                                        class="
                                                            avonni-list__item-header-link
                                                        "
                                                        href={item.href}
                                                        onclick={handleAnchorTagClick}
                                                        onmousedown={stopPropagation}
                                                    >
                                                        {item.label}
                                                    </a>
                                                    <template
                                                        if:false={item.href}
                                                    >
                                                        {item.label}
                                                    </template>
                                                </div>
                                                <span
                                                    if:true={item.hasIcons}
                                                    class="
                                                        slds-p-left_xx-small
                                                        avonni-list__item-icons
                                                    "
                                                >
                                                    <template
                                                        for:each={item.icons}
                                                        for:item="icon"
                                                    >
                                                        <span
                                                            key={icon}
                                                            class="
                                                                avonni-list__item-icon
                                                            "
                                                        >
                                                            <lightning-icon
                                                                class="
                                                                    slds-p-around_xxx-small
                                                                "
                                                                icon-name={icon}
                                                                size="xx-small"
                                                            ></lightning-icon>
                                                        </span>
                                                    </template>
                                                </span>
                                                <div
                                                    if:true={item.isAvatarRightOfTitle}
                                                    class={item.computedAvatarClass}
                                                >
                                                    <c-primitive-avatar
                                                        fallback-icon-name={item.avatar.fallbackIconName}
                                                        initials={item.avatar.initials}
                                                        presence={item.avatar.presence}
                                                        presence-position={item.avatar.presencePosition}
                                                        size={item.avatar.size}
                                                        src={item.avatar.src}
                                                        variant={item.avatar.variant}
                                                        data-element-id="avonni-avatar"
                                                        onmousedown={handleAvatarDragStart}
                                                    ></c-primitive-avatar>
                                                </div>
                                            </div>

                                            <!-- Description -->
                                            <p
                                                if:true={item.description}
                                                class="
                                                    slds-m-bottom_xx-small
                                                    slds-text-body_regular
                                                    slds-line-clamp_x-small
                                                    avonni-list__item-description_font
                                                "
                                            >
                                                <lightning-formatted-rich-text
                                                    value={item.description}
                                                ></lightning-formatted-rich-text>
                                            </p>

                                            <!-- Info -->
                                            <ul
                                                if:true={item.infos}
                                                class="
                                                    slds-list_horizontal
                                                    slds-has-dividers_left
                                                    slds-has-block-links
                                                "
                                            >
                                                <template
                                                    for:each={item.infos}
                                                    for:item="info"
                                                >
                                                    <li
                                                        key={info.label}
                                                        class="
                                                            avonni-list__item-info
                                                            slds-item
                                                        "
                                                        data-element-id="li-info"
                                                    >
                                                        <a
                                                            if:true={info.href}
                                                            class="
                                                                avonni-list__item-info-link
                                                            "
                                                            href={info.href}
                                                            data-element-id="a-info"
                                                            onclick={handleAnchorTagClick}
                                                            onmousedown={stopPropagation}
                                                        >
                                                            {info.label}
                                                        </a>
                                                        <span
                                                            if:false={info.href}
                                                            data-element-id="span-info"
                                                            >{info.label}
                                                        </span>
                                                    </li>
                                                </template>
                                            </ul>

                                            <!-- Fields -->
                                            <div
                                                if:true={item.fields.length}
                                                class="
                                                    slds-m-top_xx-small
                                                    avonni-list__item-fields-container
                                                "
                                                aria-hidden="false"
                                            >
                                                <c-layout
                                                    multiple-rows
                                                    data-element-id="fields-container"
                                                    onprivatelayoutconnected={handleFieldsLayoutConnected}
                                                    onprivatelayoutdisconnected={handleFieldsLayoutDisconnected}
                                                >
                                                    <template
                                                        for:each={item.fields}
                                                        for:item="field"
                                                        for:index="index"
                                                    >
                                                        <c-layout-item
                                                            key={field.key}
                                                            class="
                                                                slds-truncate
                                                            "
                                                            large-container-size={fieldAttributes.largeContainerCols}
                                                            medium-container-size={fieldAttributes.mediumContainerCols}
                                                            size={fieldAttributes.cols}
                                                            small-container-size={fieldAttributes.smallContainerCols}
                                                        >
                                                            <c-output-data
                                                                label={field.label}
                                                                type={field.type}
                                                                type-attributes={field.typeAttributes}
                                                                value={field.value}
                                                                variant={fieldAttributes.variant}
                                                                data-element-id="avonni-output-data"
                                                            ></c-output-data>
                                                        </c-layout-item>
                                                    </template>
                                                </c-layout>
                                            </div>
                                        </div>
                                        <c-primitive-avatar
                                            if:true={item.isAvatarRight}
                                            class={item.computedAvatarClass}
                                            fallback-icon-name={item.avatar.fallbackIconName}
                                            initials={item.avatar.initials}
                                            presence={item.avatar.presence}
                                            presence-position={item.avatar.presencePosition}
                                            size={item.avatar.size}
                                            src={item.avatar.src}
                                            variant={item.avatar.variant}
                                            data-element-id="avonni-avatar"
                                            onmousedown={handleAvatarDragStart}
                                        ></c-primitive-avatar>
                                        <!-- Sort icon -->
                                        <lightning-icon
                                            if:true={showSortIconRight}
                                            class="
                                                slds-m-right_x-small
                                                avonni-list__item-sortable-icon-cursor
                                            "
                                            icon-name={sortableIconName}
                                            size="x-small"
                                            data-element-id="lightning-icon-sort-right"
                                            onclick={stopPropagation}
                                        ></lightning-icon>

                                        <!-- Actions -->
                                        <div
                                            if:true={hasActions}
                                            class="
                                                avonni-list__item-actions-container
                                            "
                                            onkeydown={handleStopKeyDown}
                                        >
                                            <c-primitive-actions
                                                actions={computedActions}
                                                button-icon-size={actionButtonIconSize}
                                                button-icon-variant={actionButtonIconVariant}
                                                visible-actions={computedVisibleActions}
                                                data-element-id="primitive-actions"
                                                data-item-index={item.index}
                                                onactionclick={handleActionClick}
                                                onclick={stopPropagation}
                                                onmousedown={stopPropagation}
                                                ontouchstart={stopPropagation}
                                            ></c-primitive-actions>
                                        </div>
                                    </div>
                                </div>
                            </c-card>
                        </div>
                    </c-layout-item>
                </template>
                <c-layout-item
                    if:true={showLoadingColumn}
                    class="slds-is-relative avonni-list__lower-spinner"
                    large-container-size={loadingLargeContainerColSize}
                    medium-container-size={loadingMediumContainerColSize}
                    role="listitem"
                    size={loadingColSize}
                    small-container-size={loadingSmallContainerColSize}
                    data-element-id="loading-spinner-container"
                >
                    <lightning-spinner
                        class="slds-spinner_container"
                        alternative-text="Loading..."
                        size="small"
                        data-element-id="loading-spinner-below"
                    ></lightning-spinner>
                </c-layout-item>
            </c-layout>
            <div
                if:true={isSingleLine}
                class="
                    avonni-list__flex-col
                    slds-is-relative
                    avonni-list__page-change-button-container
                "
            >
                <lightning-button-icon
                    class="avonni-list__page-change-button"
                    alternative-text={nextButtonAlternativeText}
                    disabled={nextPageDisabled}
                    icon-name="utility:chevronright"
                    size="large"
                    variant="bare"
                    data-element-id="next-page-button"
                    onclick={handleNextPage}
                ></lightning-button-icon>
                <lightning-spinner
                    if:true={isLoading}
                    class="slds-spinner_container"
                    alternative-text="Loading..."
                    size="small"
                ></lightning-spinner>
            </div>
        </div>
    </div>
</template>
